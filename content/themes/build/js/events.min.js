'use strict';

Layout = require('./main.js');

var updateView = function updateView(selector) {
    if (document.body.classList.contains('' + selector + '') !== true) {
        document.body.classList.add('' + selector + '');
    }
};

function postURL(event) {
    if (window.location.pathname.length > 1) {
        var slug = window.location.pathname.slice(-1, 1);
        events.fetchPost(slug);
        setTimeout(function () {
            splash.classList.remove("is-visible");
        }, 200);
    } else {
        splash.classList.remove("is-visible");
    }
}
window.onload = postURL;
window.onpopstate = postURL;

var pageState = {
    isPost: function isPost() {
        window.scrollTo(0, 0);
        updateView('post-template');
    },
    isHome: function isHome() {
        window.scrollTo(0, 0);
        document.body.className = 'home-template';
    },
    isCarousel: function isCarousel() {
        updateView('carousel-template');
    },
    isContact: function isContact() {
        updateView('contact-template');
    }
};

var events = {

    showDropdown: function showDropdown() {
        projDropdown.className = 'projects-dropdown is-active';
        document.body.addEventListener('click', events.hideDropdown);
    },

    hideDropdown: function hideDropdown() {
        projDropdown.className = 'projects-dropdown';
        document.body.removeEventListener('click', events.hideDropdown);
    },

    showContact: function showContact(e) {
        e.preventDefault();
        pageState.isContact();
        var input = document.querySelectorAll('input');
        var contactSection = document.querySelector('.contact-section');

        function moveLabel() {
            var label = $(this).next('label');
            var activeInput = $(this).prev('label');
            label.addClass('hasEntry');
        }
        // input.addEventListener('focusin', moveLabel);
    },

    closeContact: function closeContact() {
        pageState.isHome();
    },

    goBack: function goBack(event) {
        event.preventDefault();
        history.replaceState(null, null, '/');
        pageState.isHome();
    },

    fetchPost: function fetchPost(slug) {
        var httpRequest = new XMLHttpRequest();
        pageState.isPost();
        splash.classList.add("is-visible");

        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == XMLHttpRequest.DONE) {
                setTimeout(function () {
                    splash.classList.remove("is-visible");
                }, 80);
                if (httpRequest.status == 200) {
                    var data = JSON.parse(httpRequest.responseText);
                    console.log(data.posts[0]);
                    layout = new Layout(data.posts[0].html, data.posts[0].title, data.posts[0].meta_description);
                    carousel = new Carousel(data.posts[0].html);
                    history.pushState(null, null, '/' + slug + '/');
                    layout.display();
                    carousel.build();
                } else if (httpRequest.status == 400) {
                    pageState.isHome();
                } else {
                    console.log('something else other than 200 was returned');
                }
            }
        };

        httpRequest.open("GET", ghost.url.api('posts/slug/' + slug));
        httpRequest.send();
    }
};

window.onpopstate = function () {
    if (window.location.pathname.length > 1) {
        pageState.isPost();
        splash.className = "splash-screen";
    } else {
        pageState.isHome();
        history.replaceState(null, null, '/');
        splash.className = "splash-screen";
    }
};

// EVENT LISTENERS

box.forEach(function (elem, i, x) {
    elem.setAttribute('data-project', i);
    elem.addEventListener('click', function (event) {
        var slug = elem.pathname.slice(1, -1);
        event.preventDefault();
        events.fetchPost(slug);
    });
});

navMenu.addEventListener('mouseover', events.showDropdown);

contactBtn.addEventListener('click', events.showContact);

contactClose.addEventListener('click', events.closeContact);

backArrow.addEventListener('click', events.goBack);

galleryBtn.forEach(function (elem, i, x) {
    elem.addEventListener('click', function (event) {
        var firstGalleryImg = document.querySelector('.gallery-item');
        firstGalleryImg.className = "gallery-item is-active";
    });
});
